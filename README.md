# 学习《七天用 Go 从零实现系列》

项目地址：
- [Gee](https://geektutu.com/post/gee.html)
- [GeeORM](https://geektutu.com/post/geeorm.html)
- [GeeRPC](https://geektutu.com/post/geerpc.html)
- [GeeCache](https://geektutu.com/post/geecache.html)

## Gee 重要的构件

- 上下文 Context：可以在中间件之间传递信息
- 路由 Router：采用 Trie 树实现
- 分组路由 RouterGroup：提供对特定路径的统一控制与管理（如 logger、鉴权等）
- 中间件 MiddleWare：洋葱模型

## GeeORM 的总结

GeeORM 的整体实现比较粗糙，比如数据库的迁移仅仅考虑了最简单的场景。实现的特性也比较少，比如结构体嵌套的场景，外键的场景，复合主键的场景都没有覆盖。ORM 框架的代码规模一般都比较大，如果想尽可能地逼近数据库，就需要大量的代码来实现相关的特性；二是数据库之间的差异也是比较大的，实现的功能越多，数据库之间的差异就会越突出，有时候为了达到较好的性能，就不得不为每个数据做特殊处理；还有些 ORM 框架同时支持关系型数据库和非关系型数据库，这就要求框架本身有更高层次的抽象，不能局限在 SQL 这一层。

GeeORM 仅 800 左右的代码是不可能做到这一点的。不过，GeeORM 的目的并不是实现一个可以在生产使用的 ORM 框架，而是希望尽可能多地介绍 ORM 框架大致的实现原理，例如

- 在框架中如何屏蔽不同数据库之间的差异；
- 数据库中表结构和编程语言中的对象是如何映射的；
- 如何优雅地模拟查询条件，链式调用是个不错的选择；
- 为什么 ORM 框架通常会提供 hooks 扩展的能力；
- 事务的原理和 ORM 框架如何集成对事务的支持；
- 一些难点问题，例如数据库迁移。
- …

## GeeRPC
- RPC(Remote Procedure Call，远程控制调用) 是一种计算机通信协议，**允许调用不同进程空间的程序**。RPC 的客户端和服务器可以在一台机器上，也可以在不同的机器上，但使用过程也和本地调用一样。
- RPC 是一种**设计**，目的是解决不同服务之间的调用问题，包含**传输协议**和**序列化协议**。
- 基于 HTTP 的 Restful API：
  
    优点：
    - HTTP 协议是基于文本的，具有更好的可读性
  
    缺点：
    - Restful 接口需要额外的定义，无论是客户端还是服务端，都需要额外的代码来处理，而 RPC 调用更接近于直接调用
    - 基于 HTTP 协议的 Restful 报文冗余，承载了过多的无效信息，而 RPC 通常使用自定义的协议格式，减少冗余报文
    - RPC 可以采用更高效的序列化协议，将文本转为二进制传输，获得更高的性能
    - RPC 的灵活性，更容易扩展和集成诸如注册中心、负载均衡等功能
- 如果两台机器上的两个应用程序需要通信，首先要解决**传输协议**（例如 TCP、HTTP、Unix Socket）、**编码格式**（例如 JSON、XML），以及一系列**可用性问题**（连接超时处理、异步请求与并发支持等）。如果服务端实例很多，客户端不需要关系这些实例的具体地址和位置，就可以通过**注册中心**和**负载均衡**来解决 —— 服务端在启动时将自己注册到注册中心，客户端调用时从注册中心获取实例，因此只需要服务端和客户端感知注册中心即可，注册中心通常还需要实现服务动态添加、删除，使用心跳确保服务处于可用状态等功能。
- RPC 框架所要解决的问题：如果服务端是由不同团队提供，各个团队的服务提供方就需要各自实现一套消息编解码、连接池、收发线程、超时处理等业务之外的功能，这部分的公用功能可以通过 RPC 框架来提供。
  ![RPC](https://pic3.zhimg.com/80/v2-28e8906c2e222da044bba1a89ee0be4e_1440w.jpg?source=1940ef5c)
- GeeRPC 实现的功能：从零实现标准库 `net/rpc`
  - 协议交换（protocol exchange）
  - 注册中心（registry）
  - 服务发现（service discovery）
  - 负载均衡（load balance）
  - 超时处理（timeout processing）
- 总结：
  1. 实现了服务端以及支持并发的客户端
  2. 支持选择不同的序列化协议（GOB、JSON）
  3. 为了防止服务挂死，在一些关键地方添加了超时处理机制
  4. 支持多种传输协议（TCP、Unix、HTTP）
  5. 支持多种负载均衡模式
  6. 实现了简易的服务注册中心和发现模块

## GeeCache
- 设计一个分布式缓存系统，需要考虑资源控制、淘汰策略、并发、分布式节点通信等问题
- GeeCache 实现的特性有：
  - 单机缓存和基于 HTTP 的分布式缓存
  - 最近最少访问（Least Recently Used，LRU）缓存策略
  - 使用 Go 锁机制防止缓存击穿
  - 使用一致性哈希选择节点，实现复杂均衡
  - 使用 protobuf 优化节点间二进制通信